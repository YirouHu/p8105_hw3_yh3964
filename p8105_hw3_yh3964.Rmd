---
title: "p8105_hw3_yh3964"
author: "Yirou Hu"
date: "2025-10-08"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Load packages and datasets
```{r}
library(patchwork)
library(tidyverse)
library(dplyr)
library(p8105.datasets)
data("instacart") 
```

Set the size of plots

```{r}
knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = 0.6,
  out.width = "90%"
)
```

Change legend position to bottom and remove the frame

```{r}
theme_set(theme_minimal() + theme(legend.position = "bottom")) 
```

We change continuous and discrete variables with "viridis" for color and fill

```{r}
options(
  ggplot2.continuous.colour = "viridis",
  ggplot2.continuous.fill = "viridis"
)

scale_colour_discrete = scale_colour_viridis_d
scale_fill_discrete = scale_fill_viridis_d
```


# Problem 1

The goal is to do some exploration of this dataset. To that end, write a short description of the dataset, noting the size and structure of the data, describing some key variables, and giving illstrative examples of observations. Then, do or answer the following (commenting on the results of each)

## How many aisles are there, and which aisles are the most items ordered from?

```{r}
aisles_number_df = 
  instacart |>
  group_by(aisle) |>
  summarize(count_aisle = n()) |>
  mutate(aisle_rank = rank(desc(count_aisle))) |>
  arrange(aisle_rank)
```

Dataset description:

The whole dataset provides detailed information on each product that customers ordered, including the product name, department, and aisle, as well as the information about the time they make this order, such as order_dow and order_hour_of_day. Additionally, it includes informaiton about whether the product was reordered, the order number, and the number of days since the prior order. The product id, aisle id and the order they belonged to are also provided.

There are `r length(unique(instacart$aisle))` aisles and `r aisles_number_df$aisle[which(aisles_number_df$aisle_rank ==1)]` is the aisle with the most items ordered from.

## Make a plot that shows the number of items ordered in each aisle, limiting this to aisles with more than 10000 items ordered. Arrange aisles sensibly, and organize your plot so others can read it.

```{r, fig.width = 20, fig.height = 25}
instacart |>
  group_by(aisle) |>
  summarize(count_aisle = n()) |>
  arrange(count_aisle) |>
  filter(count_aisle > 10000) |>
  ggplot(aes(x = count_aisle, y = reorder(aisle, -count_aisle))) +
  geom_bar(stat = "identity", fill = "blue", alpha = 0.5) +
  labs(                                             
    title = "Number of Items Ordered in Each Aisle",
    x = "Number of Items Ordered",
    y = "Aisle"
  ) 
```

Plot description:

This bar chart shows the number of items ordered from each aisle. It's clear that "fresh vegetables" and "fresh fruits" are the most popular, with the highest order counts. Other top sellers include "packaged vegetables and fruits," "yogurt," and "packaged cheese." Less ordered items come from aisles like "butter" and "oils vinegars," yet they still exceed 10,000 orders. This chart helps identify which products are in highest demand.

## Make a table showing the three most popular items in each of the aisles “baking ingredients”, “dog food care”, and “packaged vegetables fruits”. Include the number of times each item is ordered in your table.

```{r}
popular_items_df = 
  instacart |>
  filter(aisle %in% c("baking ingredients", "dog food care", "packaged vegetables fruits")) |>
  group_by(aisle, product_name) |>
  summarise(number_of_time = n()) |>
  mutate(rank_of_time = rank(desc(number_of_time))) |>
  arrange(rank_of_time) |>
  filter(rank_of_time == c(1,2,3)) |>
  arrange(desc(number_of_time)) 

popular_items_df |>
  knitr::kable(col.names = c("Aisle", "Product Name", "Number of times ordered", "Rank"))
```

## Make a table showing the mean hour of the day at which Pink Lady Apples and Coffee Ice Cream are ordered on each day of the week; format this table for human readers (i.e. produce a 2 x 7 table).

```{r}
instacart |>
  filter(product_name %in% c("Pink Lady Apples", "Coffee Ice Cream")) |>
  group_by(product_name, order_dow) |>
  summarise(mean_order_hour_of_day = mean(order_hour_of_day)) |>
  pivot_wider(
    names_from = order_dow,
    values_from = mean_order_hour_of_day
  ) |>
  knitr::kable() 
```

The table shows the average ordering hours for "Pink Lady Apples" and "Coffee Ice Cream" by day of the week. "Coffee Ice Cream" orders peak mid-week, especially on Wednesdays around 15 hours. "Pink Lady Apples" are most ordered on Thursdays around 14 hours. 


# Problem 2
This Problem uses the Zillow datasets introduced in Homework 2.

We first do data cleaning about zip code datasets.
```{r}
zip_codes_df = 
  read_csv("zillow_data/Zip Codes.csv") |>
  janitor::clean_names() |> 
  select(-state_fips, -file_date) |> 
  distinct(zip_code, .keep_all = TRUE)
```


Next, we do data cleaning on zillow rent price dataset.
```{r}
zillow_rent_df = 
  read_csv("zillow_data/Zip_zori_uc_sfrcondomfr_sm_month_NYC.csv") |>
  pivot_longer(
    cols = "2015-01-31":"2024-08-31",
    names_to = "Date",
    values_to = "Zori"
  ) |> 
  rename(
     zip_code = "RegionName",
     region_id = "RegionID",
     size_rank = "SizeRank",
     state = "State",
     county_name = "CountyName"
  ) |>
  select(zip_code, -RegionType, -StateName, -City, -Metro, everything()) |>
  drop_na(Zori)
  
```

We merge them together
```{r}
zip_zillow_merge_df =
  left_join(zillow_rent_df, zip_codes_df, by = "zip_code") |>
  separate(Date, into = c("year", "month", "day"), sep = "-") |>
  mutate(
    borough = case_match(
    county_name,
      "Bronx County" ~ "Bronx",
      "Kings County" ~ "Brooklyn",
      "New York County" ~ "Manhattan",
      "Queens County" ~ "Queens",
      "Richmond County" ~ "Staten Island"
    )
  )
```

## There are 116 months between January 2015 and August 2024. How many ZIP codes are observed 116 times? How many are observed fewer than 10 times? Why are some ZIP codes are observed rarely and others observed in each month?

Answer: 

- There are `r nrow(zip_zillow_merge_df |> count(zip_code) |> filter(n == 116))` ZIP codes observed 116 times.
- There are `r nrow(zip_zillow_merge_df |> count(zip_code) |> filter(n < 10))` ZIP codes observed fewer than 10 times. 
- The reason for ZIP codes are observed rarely and other are observed in each month is due to the data availability and collection ability of Zillow. 
- Furthermore, some ZIP codes may contain industrial zones, commercial areas, parks, or other non-residential regions, where typical rental data is unavailable.
- Moreover, there exists missing ZIP codes correspond to areas with smaller populations or fewer rental units. Zillow may not have enough transactions to generate reliable rental price estimates.

## Create a reader-friendly table showing the average rental price in each borough and year (not month). Comment on trends in this table.

```{r}
average_rent_df =
  zip_zillow_merge_df |> 
  group_by(borough, year) |> 
  summarize(
    average_rent_price = mean(Zori, na.rm = TRUE)
  ) 
  
average_rent_df |>  
  knitr::kable()
```

Comments on table: 

- The table presents the average rental prices for different boroughs of New York City from 2015 to 2024. All boroughs have seen an increase in average rental prices over the decade. This suggests a general trend of rising rents across the city.
- Manhattan: Manhattan has the highest average rental prices throughout the period, with a noticeable increase from $3,022 in 2015 to $4,078 in 2024. The largest year-over-year increase appears between 2022 and 2023.
- Brooklyn: Brooklyn starts with lower rents compared to Manhattan but shows a steady increase, reaching $3,126 by 2024. The most significant rise occurs between 2021 and 2022.
- Queens: Queens also exhibits a consistent upward trend, with rents rising from $2,214 in 2015 to $2,694 in 2024. The increase is more gradual compared to Manhattan and Brooklyn.
- Bronx: Starting with the lowest average rents among the boroughs, Bronx sees a gradual increase over the years, with a more pronounced rise from 2021 onwards, reaching $2,496 in 2024.
- Staten Island: Data for Staten Island begins in 2020, and it shows a steady increase in rental prices from that year through 2024, with the average rent rising from $1,977 to $2,536.
- In summary, the table indicates a overall increase in rental prices across all boroughs over the ten-year span, with Manhattan maintaining the highest rents and The Bronx starting with the lowest but showing a significant increase in recent years.

## Make a plot showing NYC Rental Prices within ZIP codes for all available years. Your plot should facilitate comparisons across boroughs. Comment on any significant elements of this plot.

```{r, fig.width = 10, fig.height = 30} 
prices_year_plot =
zip_zillow_merge_df |> 
  group_by(year, zip_code, borough) |> 
  ggplot(aes(x = year, y = Zori)) +
  geom_point(color = "red", alpha = 0.3) +
  geom_line(alpha = 0.4, linewidth = 0.5) +
  labs(
    x = "Borough",
    y = "NYC Rental Prices",
    title = "Rental Prices Across Different Boroughs"
  ) +
  facet_wrap(~ borough, ncol = 2, nrow = 3) +
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = .5))

prices_year_plot
```

Comments on plot:

- The plot illustrates the rental price trends across different boroughs of NYC from 2015 to 2024. All boroughs exhibit a general upward trend in rental prices over the years, reflecting a growing demand or increasing cost of living. The range of prices within each borough varies, with Manhattan showing the most significant variability, suggesting diverse rental options.
- Manhattan : Manhattan consistently shows the highest rental prices across all years, indicating a strong and possibly exclusive rental market.
- Staten Island : Staten Island starts with the lowest prices but shows a notable increase towards 2024.


## Compute the average rental price within each ZIP code over each month in 2023. Make a reader-friendly plot showing the distribution of ZIP-code-level rental prices across boroughs; put differently, your plot should facilitate the comparison of the distribution of average rental prices across boroughs. Comment on this plot

```{r fig.width = 20, fig.height = 30}
average_price_plot =
zip_zillow_merge_df |> 
  filter(year == 2023) |> 
  group_by(month, zip_code, borough) |> 
  summarize(
    average_rent_price = mean(Zori, na.rm = TRUE)
  ) |> 
  ggplot(aes(x = borough, average_rent_price)) +
  geom_violin(aes(fill = borough), alpha = 0.5) +
  labs(
    x = "Borough",
    y = "NYC Average Rental Price",
    title = "Comparison of Distribution of Average Rental Prices Across Boroughs in 2023 ",
  ) + 
  theme(axis.text.x = element_text(angle = 0, hjust = 1, vjust = 0.5))

average_price_plot
```

Comments on the plot:

- The violin plot illustrates the distribution of average rental prices across different boroughs of New York City for the year 2023. Manhattan displays the broadest range of rental prices, indicating significant variability in the housing market.
- The thickest part of each violin plot, representing the median, shows that Manhattan also has the highest median rental price, followed by Brooklyn, Queens, The Bronx, and Staten Island.
- The shape of the violin plots reveals the skewness of the rental price distributions. Manhattan and Brooklyn show a right-skewed distribution, suggesting a few extremely high rental prices.
- The width of the violins indicates the spread of rental prices. Queens and The Bronx have narrower violins, suggesting a more concentrated rental price range compared to Manhattan and Brooklyn.
- The thin ends of the violin plots suggest the presence of outliers, particularly in Manhattan, where there are a few ZIP codes with substantially higher rental prices.

## Combine the two previous plots into a single graphic, and export this to a results folder in your repository.

```{r}
combined_plot = prices_year_plot / average_price_plot
ggsave(filename = "D:/硕士/研一/Data Science I/hw/p8105_hw3_yh3964/p8105_hw3_yh3964/result/combined plot.pdf", plot = combined_plot, width = 9, height = 12)
```

